<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for node-npmtest-clam/node_modules/clam/lib/compile.js</title>
    <meta charset="utf-8">
    <style>
        body, html {
            margin:0; padding: 0;
        }
        body {
            font-family: Arial, Helvetica;
            font-size: 10pt;
        }
        div.header, div.footer {
            background: #eee;
            padding: 1em;
        }
        div.header {
            height: 160px;
            padding: 0 1em 0 1em;
            z-index: 100;
            position: fixed;
            top: 0;
            border-bottom: 1px solid #666;
            width: 100%;
        }
        div.footer {
            border-top: 1px solid #666;
        }
        div.body {
            margin-top: 170px;
        }
        div.meta {
            font-size: 90%;
            text-align: center;
        }
        h1, h2, h3 {
            font-weight: normal;
        }
        h1 {
            font-size: 12pt;
        }
        h2 {
            font-size: 10pt;
        }
        pre {
            font-family: Menlo, Monaco, Consolas, Courier New, monospace;
            margin: 0;
            padding: 0;
            font-size: 14px;
            tab-size: 2;
        }

        div.path { font-size: 110%; }
        div.path a:link, div.path a:visited { color: #000; }
        table.coverage { border-collapse: collapse; margin:0; padding: 0 }

        table.coverage td {
            margin: 0;
            padding: 0;
            color: #111;
            vertical-align: top;
        }
        table.coverage td.line-count {
            width: 50px;
            text-align: right;
            padding-right: 5px;
        }
        table.coverage td.line-coverage {
            color: #777 !important;
            text-align: right;
            border-left: 1px solid #666;
            border-right: 1px solid #666;
        }

        table.coverage td.text {
        }

        table.coverage td span.cline-any {
            display: inline-block;
            padding: 0 5px;
            width: 40px;
        }
        table.coverage td span.cline-neutral {
            background: #eee;
        }
        table.coverage td span.cline-yes {
            background: #b5d592;
            color: #999;
        }
        table.coverage td span.cline-no {
            background: #fc8c84;
        }

        .cstat-yes { color: #111; }
        .cstat-no { background: #fc8c84; color: #111; }
        .fstat-no { background: #ffc520; color: #111 !important; }
        .cbranch-no { background:  yellow !important; color: #111; }

        .cstat-skip { background: #ddd; color: #111; }
        .fstat-skip { background: #ddd; color: #111 !important; }
        .cbranch-skip { background: #ddd !important; color: #111; }

        .missing-if-branch {
            display: inline-block;
            margin-right: 10px;
            position: relative;
            padding: 0 4px;
            background: black;
            color: yellow;
        }

        .skip-if-branch {
            display: none;
            margin-right: 10px;
            position: relative;
            padding: 0 4px;
            background: #ccc;
            color: white;
        }

        .missing-if-branch .typ, .skip-if-branch .typ {
            color: inherit !important;
        }

        .entity, .metric { font-weight: bold; }
        .metric { display: inline-block; border: 1px solid #333; padding: 0.3em; background: white; }
        .metric small { font-size: 80%; font-weight: normal; color: #666; }

        div.coverage-summary table { border-collapse: collapse; margin: 3em; font-size: 110%; }
        div.coverage-summary td, div.coverage-summary table  th { margin: 0; padding: 0.25em 1em; border-top: 1px solid #666; border-bottom: 1px solid #666; }
        div.coverage-summary th { text-align: left; border: 1px solid #666; background: #eee; font-weight: normal; }
        div.coverage-summary th.file { border-right: none !important; }
        div.coverage-summary th.pic { border-left: none !important; text-align: right; }
        div.coverage-summary th.pct { border-right: none !important; }
        div.coverage-summary th.abs { border-left: none !important; text-align: right; }
        div.coverage-summary td.pct { text-align: right; border-left: 1px solid #666; }
        div.coverage-summary td.abs { text-align: right; font-size: 90%; color: #444; border-right: 1px solid #666; }
        div.coverage-summary td.file { text-align: right; border-left: 1px solid #666; white-space: nowrap;  }
        div.coverage-summary td.pic { min-width: 120px !important;  }
        div.coverage-summary a:link { color: #000; }
        div.coverage-summary a:visited { color: #333; }
        div.coverage-summary tfoot td { border-top: 1px solid #666; }

        div.coverage-summary .yui3-datatable-sort-indicator, div.coverage-summary .dummy-sort-indicator {
            height: 10px;
            width: 7px;
            display: inline-block;
            margin-left: 0.5em;
        }
        div.coverage-summary .yui3-datatable-sort-indicator {
            background: no-repeat scroll 0 0 transparent;
        }
        div.coverage-summary .yui3-datatable-sorted .yui3-datatable-sort-indicator {
            background-position: 0 -20px;
        }
        div.coverage-summary .yui3-datatable-sorted-desc .yui3-datatable-sort-indicator {
            background-position: 0 -10px;
        }

        .high { background: #b5d592 !important; }
        .medium { background: #ffe87c !important; }
        .low { background: #fc8c84 !important; }

        span.cover-fill, span.cover-empty {
            display:inline-block;
            border:1px solid #444;
            background: white;
            height: 12px;
        }
        span.cover-fill {
            background: #ccc;
            border-right: 1px solid #444;
        }
        span.cover-empty {
            background: white;
            border-left: none;
        }
        span.cover-full {
            border-right: none !important;
        }
        pre.prettyprint {
            border: none !important;
            padding: 0 !important;
            margin: 0 !important;
        }
        .com { color: #999 !important; }
        .ignore-none { color: #999; font-weight: normal; }

    </style>
</head>
<body>
<div class="header low">
    <h1 style="font-weight: bold;">
        <a href="https://github.com/npmtest/node-npmtest-clam">npmtest-clam (v0.0.1)</a>
    </h1>
    <h1>Code coverage report for <span class="entity">node-npmtest-clam/node_modules/clam/lib/compile.js</span></h1>
    <h2>
        
        Statements: <span class="metric">8.12% <small>(22 / 271)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Branches: <span class="metric">0% <small>(0 / 95)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Functions: <span class="metric">0% <small>(0 / 26)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        
        Lines: <span class="metric">8.27% <small>(22 / 266)</small></span> &nbsp;&nbsp;&nbsp;&nbsp;
        
        Ignored: <span class="metric"><span class="ignore-none">none</span></span> &nbsp;&nbsp;&nbsp;&nbsp;
    </h2>
    <div class="path"><a href="../../../../index.html">All files</a> &#187; <a href="index.html">node-npmtest-clam/node_modules/clam/lib/</a> &#187; compile.js</div>
</div>
<div class="body">
<pre><table class="coverage">
<tr><td class="line-count">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499</td><td class="line-coverage"><span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-yes">6</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">var debug = require('debug')('clam:compile');
var fs = require('fs');
var path = require('path');
var isUtf8 = require('is-utf8');
var _ = require('underscore');
var iconv = require('iconv-lite');
var util = require('util');
var config = require('./config.js');
var proxy = require("./proxy.js");
var assetUrl = require('./asseturl.js');
&nbsp;
<span class="cstat-no" title="statement not covered" >var J = require("juicer");</span>
<span class="cstat-no" title="statement not covered" >J.register('stringify', JSON.stringify);</span>
<span class="cstat-no" title="statement not covered" >J.register("random", <span class="fstat-no" title="function not covered" >function(){</span> <span class="cstat-no" title="statement not covered" >return (new Date()).valueOf(); </span>});</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >var mocker = require('./mocker.js');</span>
<span class="cstat-no" title="statement not covered" >var assetsTool = require('./assetsTool');</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >var scriptExtern = /&lt;script[^&gt;]*? src=['"]([^"']*?)['"].*?&gt;&lt;\/script&gt;/g;</span>
<span class="cstat-no" title="statement not covered" >var styleExtern = /&lt;link[^&gt;]*? href=['"]([^"']*?)['"].*&gt;/g;</span>
<span class="cstat-no" title="statement not covered" >var assetsToolExtern = /\$assetsTool.(use|require|injectScript|injectStyle)\((['"][^\s^\$]*['"]\s*,?\s*){0,2}\)/g;</span>
<span class="cstat-no" title="statement not covered" >var recoverAssetsToolExtern = /\{\{__assetsTool__\d*\}\}/g;</span>
<span class="cstat-no" title="statement not covered" >var assetsToolPrefix = '__assetsTool__';</span>
&nbsp;
/**
 * 从一段文本中抽离Assets
 * @param pageContent
 * @returns {{scripts: Array, styles: Array, pageContent: XML}}
 */
<span class="fstat-no" title="function not covered" >function takeOutAssets(pageContent) {</span>
<span class="cstat-no" title="statement not covered" >    pageContent = pageContent.replace(/\&lt;\!\-\-^#.*\-\-\&gt;/g, '');</span>
<span class="cstat-no" title="statement not covered" >    var head_scripts = [], tail_scripts = [];</span>
<span class="cstat-no" title="statement not covered" >    var styles = [];</span>
<span class="cstat-no" title="statement not covered" >    var movetoReg = /clam-moveto=['"]([^"']*?)['"]/;</span>
<span class="cstat-no" title="statement not covered" >    pageContent = pageContent.replace(scriptExtern, <span class="fstat-no" title="function not covered" >function (mm) {</span></span>
<span class="cstat-no" title="statement not covered" >        var m = mm.match(movetoReg);</span>
<span class="cstat-no" title="statement not covered" >        mm = mm.replace(movetoReg, '');</span>
<span class="cstat-no" title="statement not covered" >        if (m &amp;&amp; typeof m[1] != "undefined") {</span>
<span class="cstat-no" title="statement not covered" >            if (m[1] == "head") {</span>
<span class="cstat-no" title="statement not covered" >                head_scripts.push(mm);</span>
<span class="cstat-no" title="statement not covered" >                return '';</span>
            }
            else <span class="cstat-no" title="statement not covered" >if (m[1] == "tail") {</span>
<span class="cstat-no" title="statement not covered" >                tail_scripts.push(mm);</span>
<span class="cstat-no" title="statement not covered" >                return '';</span>
            }
            else {
<span class="cstat-no" title="statement not covered" >                return mm;</span>
            }
        }
        else {
<span class="cstat-no" title="statement not covered" >            head_scripts.push(mm);</span>
<span class="cstat-no" title="statement not covered" >            return '';</span>
        }
    });
<span class="cstat-no" title="statement not covered" >    pageContent = pageContent.replace(styleExtern, <span class="fstat-no" title="function not covered" >function ($1) {</span></span>
<span class="cstat-no" title="statement not covered" >        if ($1.match(/rel\s{0,}=\s{0,}[\'\"]stylesheet[\"\']/) || $1.match(/type\s{0,}=\s{0,}[\'\"]text\/css[\"\']/)) {</span>
<span class="cstat-no" title="statement not covered" >            styles.push($1);</span>
<span class="cstat-no" title="statement not covered" >            return '';</span>
        }
        else {
<span class="cstat-no" title="statement not covered" >            return $1;</span>
        }
    });
<span class="cstat-no" title="statement not covered" >    head_scripts = _.uniq(head_scripts);</span>
<span class="cstat-no" title="statement not covered" >    tail_scripts = _.uniq(tail_scripts);</span>
<span class="cstat-no" title="statement not covered" >    styles = _.uniq(styles);</span>
<span class="cstat-no" title="statement not covered" >    return {head_scripts: head_scripts, tail_scripts: tail_scripts, styles: styles, pageContent: pageContent};</span>
}
/**
 * 解析assetsTool内容
 * @param content 
 * @returns content
 */
<span class="fstat-no" title="function not covered" >function parseAssetsTool(content){</span>
<span class="cstat-no" title="statement not covered" >    var assetsToolPositionCount = -1;</span>
<span class="cstat-no" title="statement not covered" >    var assetsMap = [];</span>
<span class="cstat-no" title="statement not covered" >    var pageContent = content.replace(assetsToolExtern, <span class="fstat-no" title="function not covered" >function ($1, $2, $3) {</span></span>
<span class="cstat-no" title="statement not covered" >        saveAssetsMap(assetsMap,$1,++assetsToolPositionCount);</span>
<span class="cstat-no" title="statement not covered" >        return '{{'+assetsToolPrefix + assetsToolPositionCount + '}}';</span>
    });
<span class="cstat-no" title="statement not covered" >    return recoverAssetsTool(pageContent,assetsMap);</span>
}
/**
 * 生成assetsTool的模块列表
 */
<span class="fstat-no" title="function not covered" >function saveAssetsMap(root,content,pos){</span>
<span class="cstat-no" title="statement not covered" >    root.push({</span>
        express:content,
        id:pos
    });
}
/**
 * 复原assetsTool
 * @param content
 * @returns content
 */
<span class="fstat-no" title="function not covered" >function recoverAssetsTool(content,map){</span>
    // 对map排序，将injectStyle和injectStyle排到最后执行
<span class="cstat-no" title="statement not covered" >    var requireMap = [];</span>
<span class="cstat-no" title="statement not covered" >    var placeholderMap = [];</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    assetsTool.clearCacheMod();</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    map.forEach(<span class="fstat-no" title="function not covered" >function(i) {</span></span>
<span class="cstat-no" title="statement not covered" >        /\$assetsTool.inject(Script|Style).*/g.test(i.express) ?</span>
            placeholderMap.push(i):
            requireMap.push(i);
    });
&nbsp;
<span class="cstat-no" title="statement not covered" >    map = requireMap.concat(placeholderMap);</span>
<span class="cstat-no" title="statement not covered" >    var assetsResult = assetsTool.feLoader(map);</span>
&nbsp;
<span class="fstat-no" title="function not covered" >    function getAssets(id){</span>
<span class="cstat-no" title="statement not covered" >        var ret = '';</span>
<span class="cstat-no" title="statement not covered" >        assetsResult.forEach(<span class="fstat-no" title="function not covered" >function(i){</span></span>
<span class="cstat-no" title="statement not covered" >            if(i.id == id){</span>
<span class="cstat-no" title="statement not covered" >                ret = i.express;</span>
<span class="cstat-no" title="statement not covered" >                return;</span>
            }
        });
<span class="cstat-no" title="statement not covered" >        return ret;</span>
    }
<span class="cstat-no" title="statement not covered" >    content = content.replace(recoverAssetsToolExtern, <span class="fstat-no" title="function not covered" >function ($1, $2, $3) {</span></span>
<span class="cstat-no" title="statement not covered" >        return getAssets(parseInt($1.split(assetsToolPrefix)[1]));</span>
    });
<span class="cstat-no" title="statement not covered" >    return content;</span>
}
/**
 * 解析页面内容
 * @param page 页面路径
 * @param url  对应url(用于替换js和css引用)
 * @param libs 库路径
 * @param rootContent 页面路径对应的内容。如果有，则无需从页面路径获取内容
 * @return {Object}
 */
<span class="fstat-no" title="function not covered" >function parseInfo(page, libs, cdnPath, rootContent, url) {</span>
<span class="cstat-no" title="statement not covered" >    debug('--------parseInfo--------%s',url);</span>
<span class="cstat-no" title="statement not covered" >    var pageContent = ssi(page, libs, cdnPath, null, rootContent, url);</span>
<span class="cstat-no" title="statement not covered" >    var asset = takeOutAssets(pageContent);</span>
<span class="cstat-no" title="statement not covered" >    var head_scripts = asset.head_scripts, tail_scripts = asset.tail_scripts;</span>
<span class="cstat-no" title="statement not covered" >    var styles = asset.styles;</span>
<span class="cstat-no" title="statement not covered" >    pageContent = asset.pageContent;</span>
<span class="cstat-no" title="statement not covered" >    var headTail = pageContent.indexOf('&lt;/head&gt;');</span>
<span class="cstat-no" title="statement not covered" >    var bodyContent = headTail!=-1 ? pageContent.slice(headTail) : '';</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    return {file: page, pageContent: pageContent, headTail: headTail, bodyContent: bodyContent, head_scripts: head_scripts, tail_scripts: tail_scripts, styles: styles};</span>
}
&nbsp;
/**
 * 渲染一个页面为最终样式。js和css提到头部。
 * @param page
 * @param url
 * @param libs
 * @param rootContent 页面路径对应的内容。如果有，则无需从页面路径获取内容
 * @return {*}
 */
<span class="cstat-no" title="statement not covered" >var render = <span class="fstat-no" title="function not covered" >function(page, libs, cdnPath, rootContent, url) {</span></span>
<span class="cstat-no" title="statement not covered" >    debug('--------render--------%s',url);</span>
<span class="cstat-no" title="statement not covered" >    var ret = parseInfo(page, libs, cdnPath, rootContent, url);</span>
<span class="cstat-no" title="statement not covered" >    var pageContent = ret.pageContent;</span>
<span class="cstat-no" title="statement not covered" >    var headTail = ret.headTail;</span>
<span class="cstat-no" title="statement not covered" >    var bodyContent = ret.bodyContent;</span>
<span class="cstat-no" title="statement not covered" >    var head_scripts = ret.head_scripts, tail_scripts = ret.tail_scripts;</span>
<span class="cstat-no" title="statement not covered" >    var styles = ret.styles;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    var headArea = pageContent.slice(0, headTail);</span>
<span class="cstat-no" title="statement not covered" >    var bodyTail = bodyContent.indexOf('&lt;/body&gt;');</span>
<span class="cstat-no" title="statement not covered" >    var bodyArea = bodyContent.slice(0, bodyTail);</span>
<span class="cstat-no" title="statement not covered" >    var bodyTailArea = bodyContent.slice(bodyTail);</span>
    
<span class="cstat-no" title="statement not covered" >    var head_scriptArea = '';</span>
<span class="cstat-no" title="statement not covered" >    head_scripts.forEach(<span class="fstat-no" title="function not covered" >function (s) {</span></span>
<span class="cstat-no" title="statement not covered" >        head_scriptArea += '\n' + s;</span>
    });
<span class="cstat-no" title="statement not covered" >    var tail_scriptArea = '';</span>
<span class="cstat-no" title="statement not covered" >    tail_scripts.forEach(<span class="fstat-no" title="function not covered" >function (s) {</span></span>
<span class="cstat-no" title="statement not covered" >        tail_scriptArea += '\n' + s;</span>
    });
&nbsp;
<span class="cstat-no" title="statement not covered" >    var styleArea = '';</span>
<span class="cstat-no" title="statement not covered" >    styles.forEach(<span class="fstat-no" title="function not covered" >function (s) {</span></span>
<span class="cstat-no" title="statement not covered" >        styleArea += '\n' + s;</span>
    });
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (headTail == -1) {</span>
<span class="cstat-no" title="statement not covered" >        pageContent = '&lt;html&gt;&lt;head&gt;&lt;meta charset="'+config.get('project').charset[0]+'"&gt;&lt;meta name="viewport" content="initial-scale=1" /&gt;' + styleArea + head_scriptArea + '$assetsTool.injectStyle()&lt;/head&gt;&lt;body&gt;' + pageContent + tail_scriptArea + '$assetsTool.injectScript("foot")&lt;/body&gt;&lt;/html&gt;'; </span>   }
    else {
<span class="cstat-no" title="statement not covered" >        pageContent = headArea + styleArea + head_scriptArea + bodyArea + tail_scriptArea + bodyTailArea;</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    pageContent = pageContent.replace(/\$CLAM_VER\$[\/]?/g, '');</span>
<span class="cstat-no" title="statement not covered" >    return pageContent;</span>
}
&nbsp;
/**
 * 获取自定义配置
 * @param content
 * @param reg
 */
<span class="fstat-no" title="function not covered" >function parseParam(content, reg) {</span>
<span class="cstat-no" title="statement not covered" >    var matched = content.match(reg);</span>
<span class="cstat-no" title="statement not covered" >    var ret = {};</span>
<span class="cstat-no" title="statement not covered" >    if (matched &amp;&amp; matched[1]) {</span>
<span class="cstat-no" title="statement not covered" >        matched[1].replace(/[\n\r]/g, '');</span>
<span class="cstat-no" title="statement not covered" >        try {</span>
<span class="cstat-no" title="statement not covered" >            ret = JSON.parse(matched[1]);</span>
        } catch (e) {
<span class="cstat-no" title="statement not covered" >            console.log('格式错误的模板变量:%s', matched[1]);</span>
<span class="cstat-no" title="statement not covered" >            return {};</span>
        }
<span class="cstat-no" title="statement not covered" >        return ret;</span>
    }
<span class="cstat-no" title="statement not covered" >    return ret;</span>
}
&nbsp;
<span class="fstat-no" title="function not covered" >function parsePageParam(content) {</span>
<span class="cstat-no" title="statement not covered" >    return parseParam(content, /&lt;\!--#def([\s\S]*?)--&gt;/);</span>
}
&nbsp;
<span class="fstat-no" title="function not covered" >function parseTmsParam(content) {</span>
<span class="cstat-no" title="statement not covered" >    return parseParam(content, /&lt;\!--#tms([\s\S]*?)--&gt;/);</span>
}
&nbsp;
<span class="fstat-no" title="function not covered" >function delPageParamArea(content){</span>
<span class="cstat-no" title="statement not covered" >    return content.replace(/&lt;\!--#def([\s\S]*?)--&gt;/, '');</span>
}
&nbsp;
/**
 * 返回携带内容携带真正线上资源路径的内容
 * 处理相对资源引用等
 * @param rootContent 文本内容，如果没有，则从page所指向的路径中获取
 * @param page 文件路径，如果rootContent指定，则失效
 * @param cdnPath 项目assets上线后的路径前缀
 * @returns 处理完毕后的页面/模块内容
 */
<span class="fstat-no" title="function not covered" >function textWithOnlineAssetsUrl(rootContent, page, cdnPath) {</span>
<span class="cstat-no" title="statement not covered" >    var pageContent = null;</span>
<span class="cstat-no" title="statement not covered" >    if (rootContent) {</span>
<span class="cstat-no" title="statement not covered" >        pageContent = rootContent;</span>
    }
    else {
<span class="cstat-no" title="statement not covered" >        pageContent = fs.readFileSync(page);</span>
<span class="cstat-no" title="statement not covered" >        pageContent = isUtf8(pageContent) ? pageContent.toString() : iconv.decode(pageContent, 'gbk');</span>
    }
&nbsp;
    //获取当前页面到源代码根目录的相对路径
<span class="cstat-no" title="statement not covered" >    var srcRoot = path.join(config.root(), 'src');</span>
<span class="cstat-no" title="statement not covered" >    var urlDir = path.relative(srcRoot, path.dirname(page));</span>
<span class="cstat-no" title="statement not covered" >    debug('引用文件相对路径:%s', urlDir);</span>
<span class="cstat-no" title="statement not covered" >    pageContent = assetUrl.toAbsolutePath(pageContent, urlDir);</span>
<span class="cstat-no" title="statement not covered" >    return pageContent;</span>
}
&nbsp;
/**
 * 混合模块定义和内容
 * 根据modefs中定义的偏移量，替换内容信息，重组content
 * @param modDefs
 * @param pageContent
 * @returns {string}
 */
<span class="fstat-no" title="function not covered" >function mixContentAndModules(modDefs, pageContent) {</span>
<span class="cstat-no" title="statement not covered" >    var snippets = [];</span>
<span class="cstat-no" title="statement not covered" >    var i;</span>
<span class="cstat-no" title="statement not covered" >    for (i = 0; i &lt; modDefs.length; i++) {</span>
<span class="cstat-no" title="statement not covered" >        if (i === 0) {</span>
<span class="cstat-no" title="statement not covered" >            snippets.push(pageContent.slice(0, modDefs[i].begin));</span>
<span class="cstat-no" title="statement not covered" >            continue;</span>
        }
<span class="cstat-no" title="statement not covered" >        snippets.push(pageContent.slice(modDefs[i - 1].end, modDefs[i].begin));</span>
    }
<span class="cstat-no" title="statement not covered" >    snippets.push(pageContent.slice(modDefs[modDefs.length - 1].end, pageContent.length));</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    var output = "";</span>
<span class="cstat-no" title="statement not covered" >    for (i = 0; i &lt; modDefs.length; i++) {</span>
<span class="cstat-no" title="statement not covered" >        output = output + snippets[i] + (modDefs[i].content ? modDefs[i].content : '');</span>
<span class="cstat-no" title="statement not covered" >        if (i === modDefs.length - 1) {</span>
<span class="cstat-no" title="statement not covered" >            output += snippets[i + 1];</span>
        }
    }
<span class="cstat-no" title="statement not covered" >    return output;</span>
}
&nbsp;
/**
 * 按照SSI解析输出html
 * 解析html时会依次遍历所有模块
 * 改函数处理所有与相对路径有关的内容替换，如根据相对路径替换其中的资源路径
 *
 * @param page  页面或者模块文件名的绝对路径
 * @param libs  其他模块搜索目录
 * @param cdnPath 最终assets上线后所在的cdn域名+路径前缀
 * @param parentParam 父级容器传递给当然页面片段的变量
 *                    变量使用优先级
 *                    网络&gt;本地http接口模拟&gt;if接口&gt;文件中即时定义的变量
 * @param rootContent 页面路径对应的内容。如果有，则无需从页面路径获取内容
 * @param url     页面访问url,如果该渲染请求由网络请求触发，则为请求url
 *                如果渲染请求由本地触发，则为到src目录的相对路径
 * @return {*}
 */
<span class="cstat-no" title="statement not covered" >var ssi = <span class="fstat-no" title="function not covered" >function(page, libs, cdnPath, parentParam, rootContent, url) {</span></span>
<span class="cstat-no" title="statement not covered" >    debug('开始渲染, 文件:%s,库目录:%s', page, util.inspect(libs));</span>
<span class="cstat-no" title="statement not covered" >    debug('--------ssi--------%s',url);</span>
    //页面不存在，返回空内容
<span class="cstat-no" title="statement not covered" >    if (!fs.existsSync(page)) {</span>
<span class="cstat-no" title="statement not covered" >        return '';</span>
    }
    //处理cdnpath中最后一个'/'符号。如果有，去掉。
<span class="cstat-no" title="statement not covered" >    if (cdnPath[cdnPath.length - 1] === '/') {</span>
<span class="cstat-no" title="statement not covered" >        cdnPath = cdnPath.slice(0, cdnPath.length - 1);</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    var pageContent = rootContent;</span>
<span class="cstat-no" title="statement not covered" >    if (!rootContent) {</span>
<span class="cstat-no" title="statement not covered" >        pageContent = fs.readFileSync(page);</span>
<span class="cstat-no" title="statement not covered" >        pageContent = isUtf8(pageContent) ? pageContent.toString() : iconv.decode(pageContent, 'gbk');</span>
&nbsp;
    }
<span class="cstat-no" title="statement not covered" >    var pageParam = parsePageParam(pageContent);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    var param = {};</span>
<span class="cstat-no" title="statement not covered" >    debug('getMixedMockDate1%s', util.inspect(param));</span>
    //本地参数覆盖外部参数
<span class="cstat-no" title="statement not covered" >    if (parentParam) {</span>
<span class="cstat-no" title="statement not covered" >        for (var attr in pageParam) { <span class="cstat-no" title="statement not covered" >parentParam[attr] = pageParam[attr]; </span>}</span>
<span class="cstat-no" title="statement not covered" >        param = parentParam;</span>
    }
    else {
<span class="cstat-no" title="statement not covered" >        debug('内部获取参数%s', util.inspect(pageParam));</span>
<span class="cstat-no" title="statement not covered" >        for (var attr in pageParam) {</span>
<span class="cstat-no" title="statement not covered" >            if(attr[0] === '#'){</span>
<span class="cstat-no" title="statement not covered" >                var attrFixed = attr.slice(1, attr.length);</span>
<span class="cstat-no" title="statement not covered" >                param[attrFixed] = pageParam[attr];</span>
<span class="cstat-no" title="statement not covered" >                continue;</span>
            }
<span class="cstat-no" title="statement not covered" >            param[attr] = pageParam[attr];</span>
        }
    }
<span class="cstat-no" title="statement not covered" >    debug('getMixedMockDate2%s', util.inspect(param));</span>
<span class="cstat-no" title="statement not covered" >    param = mocker.getMixedMockDate(param, url, (!!rootContent));</span>
<span class="cstat-no" title="statement not covered" >    debug('真实运作的参数%s', util.inspect(param));</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    try {</span>
<span class="cstat-no" title="statement not covered" >        pageContent = J(pageContent, param);</span>
    }
    catch (e) {
<span class="cstat-no" title="statement not covered" >        debug('Juicer出错%s\n 对象:%s', pageContent, util.inspect(param));</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    pageContent = textWithOnlineAssetsUrl(pageContent, page, cdnPath);</span>
<span class="cstat-no" title="statement not covered" >    pageContent = delPageParamArea(pageContent);</span>
&nbsp;
    //获得模块及其起始位置信息
<span class="cstat-no" title="statement not covered" >    var modDefs = getModuleDefs(pageContent);</span>
<span class="cstat-no" title="statement not covered" >    if (modDefs.length === 0) {</span>
<span class="cstat-no" title="statement not covered" >        return pageContent;</span>
    }
&nbsp;
    //获取子模块内容
<span class="cstat-no" title="statement not covered" >    var i = 0, j = 0, k = 0, d = 0,</span>
        modFile = '';
<span class="cstat-no" title="statement not covered" >    for (; i &lt; modDefs.length; i++) {</span>
        //在当前目录寻找子模块，当前目录有可能是页面目录，也有可能在模块目录中
<span class="cstat-no" title="statement not covered" >        modFile = modDefs[i].file;</span>
<span class="cstat-no" title="statement not covered" >        if (modDefs[i].tms.match(/^\d+\:/)) {</span>
<span class="cstat-no" title="statement not covered" >            modDefs[i].content = "&lt;!--#tms file=\""+modDefs[i].tms.replace(/^\d+\:/, '')+"\"--&gt;";</span>
        }
        else <span class="cstat-no" title="statement not covered" >if (modFile) {</span>
<span class="cstat-no" title="statement not covered" >            var modPath = path.join(path.dirname(page), modFile);</span>
<span class="cstat-no" title="statement not covered" >            var modExist = fs.existsSync(modPath);</span>
<span class="cstat-no" title="statement not covered" >            debug('模块%s, 路径%s,在页面库中%s', modFile, modPath, modExist);</span>
&nbsp;
            //当前目录没找到，到模块库中寻找
<span class="cstat-no" title="statement not covered" >            if (!modExist) {</span>
<span class="cstat-no" title="statement not covered" >                for (j = 0; j &lt; libs.length &amp;&amp; !modExist; j++) {</span>
<span class="cstat-no" title="statement not covered" >                    modPath = path.join(libs[j], modFile);</span>
<span class="cstat-no" title="statement not covered" >                    modExist = fs.existsSync(modPath);</span>
<span class="cstat-no" title="statement not covered" >                    if (modExist) {</span>
<span class="cstat-no" title="statement not covered" >                        break;</span>
                    }
                }
            }
&nbsp;
            //模块库中仍然没找到，令内容为空，处理其他模块
<span class="cstat-no" title="statement not covered" >            if (!modExist) {</span>
<span class="cstat-no" title="statement not covered" >                modDefs[i].content = '';</span>
<span class="cstat-no" title="statement not covered" >                continue;</span>
            }
&nbsp;
            //处理模块传参
<span class="cstat-no" title="statement not covered" >            var paramAttr = modDefs[i].param, passedParam = null;</span>
<span class="cstat-no" title="statement not covered" >            if (param) {</span>
<span class="cstat-no" title="statement not covered" >                if (paramAttr) {</span>
<span class="cstat-no" title="statement not covered" >                    if (paramAttr.match(/\:/)) {</span>
<span class="cstat-no" title="statement not covered" >                        paramAttr = paramAttr.replace(/\s{0,}([\:\,])\s{0,}/g, <span class="fstat-no" title="function not covered" >function(a,b) {<span class="cstat-no" title="statement not covered" ></span>return b;}</span>);</span>
<span class="cstat-no" title="statement not covered" >                        try {</span>
<span class="cstat-no" title="statement not covered" >                            var arr = paramAttr.split(","), m = [], deep = [], pp = {};</span>
<span class="cstat-no" title="statement not covered" >                            passedParam = {};</span>
<span class="cstat-no" title="statement not covered" >                            for (k=0; k&lt;arr.length; k++) {</span>
<span class="cstat-no" title="statement not covered" >                                m = arr[k].match(/(.+)\:(.+)/);</span>
<span class="cstat-no" title="statement not covered" >                                if (m &amp;&amp; typeof m[1] != "undefined" &amp;&amp; typeof m[2] != "undefined") {</span>
<span class="cstat-no" title="statement not covered" >                                    if (m[2].match(/^\$(.+)/)) {</span>
<span class="cstat-no" title="statement not covered" >                                        deep = m[2].replace(/^\$/,'').split('.');</span>
<span class="cstat-no" title="statement not covered" >                                        pp = param;</span>
<span class="cstat-no" title="statement not covered" >                                        for (d= 0; d&lt;deep.length; d++)    <span class="cstat-no" title="statement not covered" >pp = pp[deep[d]];</span></span>
<span class="cstat-no" title="statement not covered" >                                        passedParam[m[1]] = pp;</span>
                                    }
                                    else {
<span class="cstat-no" title="statement not covered" >                                        passedParam[m[1]] = m[2];</span>
                                    }
                                }
                            }
                        }
                        catch (e) {<span class="cstat-no" title="statement not covered" >console.log(e);}</span>
                    }
                    else {
<span class="cstat-no" title="statement not covered" >                        passedParam = param[paramAttr];</span>
                    }
                }
                else {
<span class="cstat-no" title="statement not covered" >                    passedParam = param;</span>
                }
            }
&nbsp;
<span class="cstat-no" title="statement not covered" >            debug('传递的参数是%s', util.inspect(passedParam));</span>
            //渲染所有子模块内容
<span class="cstat-no" title="statement not covered" >            modDefs[i].content = ssi(modPath, libs, cdnPath, passedParam, null, url ? url : page);</span>
        }
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    var output = mixContentAndModules(modDefs, pageContent);</span>
<span class="cstat-no" title="statement not covered" >    return output;</span>
}
&nbsp;
/**
 *
 * 返回一个Pagelet集合，一个Pagelet以数组的型式记录了以下信息
 * {
 *   file     :   文件名=&gt;eachFile,
 *   begin    :   在内容中的开始位置=&gt;itBegin,
 *   end      :   在内容中的结束位置=&gt;itEnd
 *   content  :   Pagelet的内容
 * }
 * @param c
 * @return {Array}
 */
<span class="cstat-no" title="statement not covered" >var getModuleDefs = <span class="fstat-no" title="function not covered" >function(c) {</span></span>
<span class="cstat-no" title="statement not covered" >    var file2offset = [], itBegin = 0, itEnd = 0, itFile='', itParam='', itTMS='',</span>
        it = 0, line = '', file_args = [], file = [], args = [], tms = [];
&nbsp;
<span class="cstat-no" title="statement not covered" >    while( (it = c.indexOf('&lt;!--#include', it) ) !== -1) {</span>
<span class="cstat-no" title="statement not covered" >        itTMS = itFile = itParam = '';</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >        itBegin = it;</span>
<span class="cstat-no" title="statement not covered" >        it = it + 12;</span>
<span class="cstat-no" title="statement not covered" >        while(c[it]  === ' ') <span class="cstat-no" title="statement not covered" >it++;</span></span>
<span class="cstat-no" title="statement not covered" >        itEnd = c.indexOf('--&gt;', it);</span>
<span class="cstat-no" title="statement not covered" >        itEnd = (itEnd === -1) ? (c.length-1) : (itEnd+3);</span>
&nbsp;
        // 区分简写和完整写法
<span class="cstat-no" title="statement not covered" >        line = c.slice(it, itEnd-3);</span>
<span class="cstat-no" title="statement not covered" >        if (c[it].match(/["']/)) {</span>
<span class="cstat-no" title="statement not covered" >            file_args = line</span>
                .replace(/(^\s{0,}["']\s{0,})|(\s{0,}["']\s{0,}$)/g, '')
                .split(/\s{0,}["']\s+["']\s{0,}/g);
<span class="cstat-no" title="statement not covered" >            itFile  = file_args[0];</span>
<span class="cstat-no" title="statement not covered" >            if (itFile.match(/^tms\:\d+\:/)) {</span>
<span class="cstat-no" title="statement not covered" >                itTMS = itFile.replace(/^tms\:/, '');</span>
<span class="cstat-no" title="statement not covered" >                itFile = '';</span>
            }
<span class="cstat-no" title="statement not covered" >            itParam = file_args[1] ? file_args[1] : '';</span>
        }
        else {
<span class="cstat-no" title="statement not covered" >            file = line.match(/file\s{0,}=\s{0,}["']\s{0,}([^"']*?)\s{0,}["']/);</span>
<span class="cstat-no" title="statement not covered" >            args = line.match(/data\s{0,}=\s{0,}["']\s{0,}([^"']*?)\s{0,}["']/);</span>
<span class="cstat-no" title="statement not covered" >            tms  = line.match(/tms\s{0,}=\s{0,}["']\s{0,}([^"']*?)\s{0,}["']/);</span>
<span class="cstat-no" title="statement not covered" >            itFile  = (file &amp;&amp; file[1]) ? file[1] : '';</span>
<span class="cstat-no" title="statement not covered" >            itParam = (args &amp;&amp; args[1]) ? args[1] : '';</span>
<span class="cstat-no" title="statement not covered" >            itTMS   = (tms  &amp;&amp; tms[1])  ? tms[1]  : '';</span>
        }
&nbsp;
<span class="cstat-no" title="statement not covered" >        file2offset.push({file: itFile, begin: itBegin, end: itEnd, content:'', param: itParam, tms:itTMS});</span>
<span class="cstat-no" title="statement not covered" >        it = itEnd;</span>
    }
&nbsp;
<span class="cstat-no" title="statement not covered" >    return file2offset;</span>
}
&nbsp;
<span class="cstat-no" title="statement not covered" >exports.render = render;</span>
<span class="cstat-no" title="statement not covered" >exports.ssi = ssi;</span>
<span class="cstat-no" title="statement not covered" >exports.parseInfo = parseInfo;</span>
<span class="cstat-no" title="statement not covered" >exports.textWithOnlineAssetsUrl = textWithOnlineAssetsUrl;</span>
<span class="cstat-no" title="statement not covered" >exports.getModuleDefs = getModuleDefs;</span>
<span class="cstat-no" title="statement not covered" >exports.mixContentAndModules = mixContentAndModules;</span>
<span class="cstat-no" title="statement not covered" >exports.takeOutAssets = takeOutAssets;</span>
<span class="cstat-no" title="statement not covered" >exports.parsePageParam = parsePageParam;</span>
<span class="cstat-no" title="statement not covered" >exports.parseTmsParam = parseTmsParam;</span>
<span class="cstat-no" title="statement not covered" >exports.parseAssetsTool = parseAssetsTool;</span>
&nbsp;
&nbsp;</pre></td></tr>
</table></pre>
</div>
<div class="footer">
    <div class="meta">Generated by <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a> at Thu Apr 20 2017 07:01:57 GMT+0000 (UTC)</div>
</div>
</body>
</html>
